<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>QRスキャナー</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 0; padding: 0; }
    video { width: 100%; max-height: 50vh; }
    #inputForm { padding: 10px; background: #f0f0f0; }
    input, select { font-size: 1em; margin: 5px; }
    #status { margin-top: 10px; color: green; font-weight: bold; }
  </style>
</head>
<body>
  <h2>QRコードスキャン</h2>

  <div id="inputForm">
    <label>仮払金：</label>
    <select id="karibarai">
      <option value="なし">なし</option>
      <option value="あり">あり</option>
    </select>
    <label>管理番号：</label>
    <input type="text" id="karibaraiNumber" placeholder="半角数字で入力" />
  </div>

  <video id="preview"></video>
  <div id="status"></div>

  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
  <script>
    const DOMAIN = 'k9s9s5hq7g8n.cybozu.com';
    const APP_ID = 171;
    const API_TOKEN = 'rHyAOfz3AmM2Fzvi95w8noXBUIuwHGXyvTS2YtjJ';

    const statusEl = document.getElementById('status');

    const codeReader = new ZXing.BrowserQRCodeReader();
    const videoInputDevices = await codeReader.listVideoInputDevices();
    const selectedDeviceId = videoInputDevices[0].deviceId;

    codeReader.decodeFromVideoDevice(selectedDeviceId, 'preview', async (result, err) => {
      if (result) {
        const qrData = result.getText();
        statusEl.textContent = `読み取り成功：${qrData}`;
        const recordId = extractRecordId(qrData);
        if (recordId) {
          const karibarai = document.getElementById('karibarai').value;
          const karibaraiNumber = document.getElementById('karibaraiNumber').value;
          await updateKintoneRecord(recordId, karibarai, karibaraiNumber);
          statusEl.textContent = `✅ 更新完了（ID: ${recordId}）`;
        } else {
          statusEl.textContent = '⚠️ レコードIDがURLから抽出できませんでした';
        }
      }
    });

    function extractRecordId(url) {
      const match = url.match(/record=(\d+)/);
      return match ? match[1] : null;
    }

    async function updateKintoneRecord(recordId, karibarai, karibaraiNumber) {
      const url = `https://${DOMAIN}/k/v1/record.json`;
      const body = {
        app: APP_ID,
        id: recordId,
        record: {
          '仮払金': { value: karibarai },
          'karibarai01': { value: karibaraiNumber }
        }
      };

      const res = await fetch(url, {
        method: 'PUT',
        headers: {
          'X-Cybozu-API-Token': API_TOKEN,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        const error = await res.json();
        console.error('エラー内容:', error);
        statusEl.textContent = '❌ 更新エラー';
      }
    }
  </script>
</body>
</html>
