<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>QRスキャナー</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 0; padding: 0; }
    video { width: 100%; max-height: 50vh; }
    ul { padding: 0; list-style: none; }
    li { padding: 4px 8px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; }
    .container { padding: 20px; }
    .btn { margin: 5px; padding: 5px 10px; font-size: 14px; }
  </style>
</head>
<body>
  <h2>QRコードスキャナー</h2>
  <video id="video" autoplay></video>

  <div class="container">
    <h3>読み取り済みリンク</h3>
    <ul id="qrList"></ul>
    <button class="btn" onclick="clearList()">🧹 すべてクリア</button>
  </div>

  <script src="https://unpkg.com/@zxing/browser@0.0.10/umd/index.min.js"></script>
  <script>
    const scannedLinks = new Set();
    const list = document.getElementById('qrList');

    // リストに表示する関数
    function addLinkToList(url) {
      const match = url.match(/record=(\d+)/);
      const id = match ? match[1] : '不明';

      const li = document.createElement('li');
      li.innerHTML = `ID: ${id} <button class="btn" onclick="removeItem(this)">❌</button>`;
      li.dataset.url = url;
      li.onclick = () => window.open(url, '_blank');
      list.appendChild(li);
    }

    // アイテム削除
    function removeItem(btn) {
      const li = btn.parentElement;
      list.removeChild(li);
      scannedLinks.delete(li.dataset.url);
    }

    // 全削除
    function clearList() {
      if (confirm('すべてのリンクを削除しますか？')) {
        list.innerHTML = '';
        scannedLinks.clear();
      }
    }

    // スキャン処理
    async function startScanner() {
      const codeReader = new ZXing.BrowserQRCodeReader();
      const videoInputDevices = await codeReader.getVideoInputDevices();
      const selectedDeviceId = videoInputDevices[0]?.deviceId;

      codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
        if (result) {
          const url = result.getText();
          if (!scannedLinks.has(url)) {
            scannedLinks.add(url);
            addLinkToList(url);
          }
        }
      });
    }

    startScanner().catch(e => alert('カメラの使用が許可されていないか、デバイスが見つかりませんでした。'));
  </script>
</body>
</html>
